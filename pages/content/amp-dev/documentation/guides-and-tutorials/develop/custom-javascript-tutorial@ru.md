---
$title: Создание UI-виджета с помощью пользовательского кода JavaScript
$order: 101
formats:
- сайты
tutorial: true
author:
- morsssss
- CrystalOnScript
description: Для веб-ресурсов, требующих высокой степени настройки, был создан amp-script — компонент, позволяющий применять на AMP-странице произвольный код JavaScript, не оказывающий негативного влияния на ее производительность.
---

В ходе этого урока вы научитесь тому, как использовать `<amp-script>` — компонент, позволяющий разработчикам писать пользовательский код JavaScript в AMP. Вы создадите виджет, проверяющий содержимое поля пароля и разрешающий отправить пароль только при соблюдении определенных требований. AMP уже предоставляет эту функциональность в виде компонента `<amp-form>`, однако `<amp-script>` позволит вам создать индивидуально настроенный процесс.

## Что вам потребуется

- Современный веб-браузер
- Базовое знание HTML, CSS и JavaScript
- Одно из двух:
    - локальный веб-сервер и редактор кода, например [SublimeText](https://www.sublimetext.com) или [VSCode](https://code.visualstudio.com/)
    - *или* [CodePen](https://codepen.io/), [Glitch](https://glitch.com/) или схожая онлайн-песочница

## Вводная информация

AMP нацелен на то, чтобы делать сайты более быстрыми и стабильными. Чрезмерный объем JavaScript-кода может замедлять веб-страницу. Однако иногда требуется создать функциональность, которая не предусмотрена компонентами AMP. В таких случаях вы можете использовать компонент [`<amp-script>`](../../../documentation/components/reference/amp-script.md), чтобы писать пользовательский JavaScript-код.

Давайте начнем!

# С чего начать

Чтобы получить начальный код, скачайте или клонируйте [данный репозиторий с GitHub](https://github.com/ampproject/samples/tree/master/amp-script-tutorial). Сделав это, перейдите (`cd`) в созданную директорию. Вы увидите две директории: `starter_code` и `finished_code`. `finished_code` содержит файлы, которые вы создадите в ходе данного урока, поэтому пока пропустим ее.  Вместо этого перейдите (`cd`) в директорию `starter_code` — там находится веб-страница, в которой наша форма реализована с помощью одного компонента [`<amp-form>`](../../../documentation/components/reference/amp-form.md) без применения `<amp-script>`.

Чтобы выполнить это упражнение, вам необходимо запустить на компьютере веб-сервер. Если он уже запущен: в зависимости от используемой вами конфигурации базовая веб-страница уже может быть доступна — попробуйте открыть ее, введя в браузере URL `http://localhost/amp-script-tutorial/starter_code/index.html`.

При отсутствии работающего сервера вы можете создать упрощенный локальный сервер — например, с помощью [serve](https://www.npmjs.com/package/serve), сервера статичного контента, основанного на [Node.js](https://nodejs.org/). Если Node.js не установлен, скачайте его [здесь](https://nodejs.org/). После установки Node.js введите в командную строку команду `npx serve`, после чего вы сможете открыть свой веб-сайт по следующей ссылке:

`http://localhost:5000/`

Также можно использовать онлайн-песочницу наподобие [Glitch](https://glitch.com/) или [CodePen](https://codepen.io/). Там содержится тот же самый код, что в репозитории GitHub, поэтому при желании можно начать с него.

Итак, введя URL, вы увидите стартовую веб-страницу:

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/starter-form.jpg', 600, 325, layout='intrinsic', alt='Web form with email and password inputs', align='center' ) }}

Откройте `starter_code/index.html` в своем любимом редакторе кода и взгляните на HTML формы. Обратите внимание, что соответствующий полю пароля элемент `<input>` содержит следующий атрибут:

```html
on="tap:rules.show; input-debounced:rules.show"
```

Он инструктирует AMP отобразить элемент `<div>` с наименованием «rules», когда пользователь нажмет на элемент `<input>`, соответствующий полю пароля, а также после того, как пользователь введет в это поле какие-либо символы. Для этой цели более предпочтительным представляется использовать событие `focus`, что позволило бы также охватить ситуацию, когда пользователь переходит в поле кнопкой Tab. На момент написания данного урока AMP не передает это событие, поэтому у нас нет такой возможности. Однако не волнуйтесь — мы решим эту проблему с помощью `<amp-script>`!

Элемент `<input>`, соответствующий полю пароля, содержит еще один интересный атрибут:

```html
pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-z\d]).{8,}$"
```

Это регулярное выражение состоит из набора более мелких регулярных выражений, каждое из которых выражает одно из наших правил валидации. AMP [не позволит отправить эту форму](../../../documentation/components/reference/amp-form.md#verification), если содержимое поля не будет совпадать с этими регулярными выражениями. В таком случае пользователь увидит сообщение об ошибке с дополнительной информацией:

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/starter-form-error.jpg', 600, 442, layout='intrinsic', alt='Web form showing error message', align='center' ) }}

[tip type="note"] Поскольку предоставленный код не оснащен веб-службой, которая обрабатывает отправку форм, при отправке формы ничего не произойдет. Однако вы, разумеется, можете добавить эту возможность в собственном коде! [/tip]

Такая реализация будет работать, однако, к сожалению, AMP не сможет сообщить нам, какое из проверочных правил было нарушено — это невозможно узнать, поскольку нам пришлось «сплющить» все правила в одно регулярное выражение.

Давайте воспользуемся `<amp-script>`, чтобы создать более удобную для пользователя версию.

# Воссоздание кода с помощью <amp-script></amp-script>

Чтобы использовать `<amp-script>`, нам необходимо импортировать его собственный JavaScript-код. Откройте файл `index.html` и добавьте в тег `<head>` следующий код.

```html
<head>
 ...
  <script async custom-element="amp-script" src="https://cdn.ampproject.org/v0/amp-script-0.1.js"></script>
  ...
</head>
```

`<amp-script>` позволяет использовать пользовательский JavaScript-код как во встроенном виде, так и из внешнего файла. Код, который будет создан в рамках данного упражнения, достаточно объемный, поэтому мы будем использовать внешний файл. Создайте новую директорию `js` и добавьте в нее новый файл `validate.js`.

`<amp-script>` позволяет вашему JavaScript манипулировать включенными в компонент дочерними элементами DOM. Он копирует эти элементы в виртуальную структуру DOM и предоставляет вашему коду доступ к ней. В данном упражнении мы хотим, чтобы JavaScript управлял нашим элементом `<form>` и его содержимым. Для этого мы обернем `<form>` компонентом `<amp-script>` следующим образом:

```html
<amp-script src="js/validate.js" layout="fixed" sandbox="allow-forms" height="500" width="750">
  <form method="post" action-xhr="#" target="_top" class="card">
    ...
  </form>
</amp-script>
```

Наш `<amp-script>` содержит атрибут `sandbox="allow-forms"`, который сообщает AMP, что скрипт может редактировать содержимое формы.

Поскольку AMP стремится гарантировать пользователю быстрое и визуально стабильное взаимодействие, AMP не позволит нашему JavaScript-коду вносить произвольные изменения в DOM когда угодно. Возможности JavaScript по внесению изменений расширяются, если компонент `<amp-script>` имеет фиксированный размер. Более существенные изменения также можно вносить после того, как пользователь провзаимодействует со страницей. Подробные сведения см. в [справочной документации](../../../documentation/components/reference/amp-script.md). Для данного урока достаточно знать, что мы указали тип `layout`, который не является `container`, и сделали размер компонента неизменным с помощью атрибутов HTML. Это означает, что все манипуляции с DOM ограничены определенной областью страницы.

Если вы пользуетесь расширением Chrome [AMP validator](https://chrome.google.com/webstore/detail/amp-validator/nmoffdblmcmgeicmolmhobpoocbbmknc), на данном этапе вы увидите сообщение об ошибке:

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/relative-url-error.png', 600, 177, layout='intrinsic', alt='Error about relative URL', align='center' ) }}

[tip type="note"] Если у вас нет этого расширения, добавьте `#development=1` к своему URL и AMP станет выводить ошибки валидации в вашу Консоль. [/tip]

Что это означает? Для загрузки JavaScript-кода `<amp-script>` из внешнего файла требуется указывать абсолютный URL. Мы можем решить эту проблему, используя `http://localhost/js/validate.js`. Однако AMP также требует применять [HTTPS](https://developers.google.com/web/fundamentals/security/encrypt-in-transit/why-https), поэтому мы все равно получим ошибку валидации, а описание настройки SSL на нашем локальном веб-сервере выходит за рамки данного урока. Если вы хотите сделать это, следуйте инструкциям в [данной публикации](https://timonweb.com/posts/running-expressjs-server-over-https/).

Далее мы можем удалить из нашей формы атрибут `pattern` с его регулярным выражением — он нам больше не нужен!

Мы также удалим атрибут `on`, который сейчас используется для показа правил ввода нашего пароля. Вместо этого, как упоминалось выше, мы будем использовать `<amp-script>` для регистрации события браузера `focus`.

```html
pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-z\d]).{8,}$"
on="tap:rules.show; input-debounced:rules.show"
```

Теперь давайте убедимся, что наш `<amp-script>` работает. Откройте созданный вами файл `validate.js` и добавьте отладочное сообщение:

```js
console.log("Hello, amp-script!");
```

Перейдите в браузер, откройте консоль и перезагрузите страницу. Убедитесь, что сообщение отобразилось.

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/hello-amp-script.png', 600, 22, layout='intrinsic', alt='Hello amp-script message in Console', align='center' ) }}

## Где мой JavaScript?

`<amp-script>` запускает ваш JavaScript в Web Worker. Веб-воркеры не могут обращаться к DOM напрямую, поэтому `<amp-script>` предоставляет воркеру доступ к виртуальной копии DOM, которую синхронизирует с реальным DOM. `<amp-script>` эмулирует множество распространенных DOM API, почти все из которых вы можете использовать в своем JavaScript-коде как обычно.

Если нужно выполнить отладку скрипта, вы можете устанавливать точки останова в веб-воркерном JavaScript-коде таким же образом, как в любом другом JavaScript. Вам нужно лишь знать, где найти его.

В Chrome DevTools откройте вкладку «Sources». В ее нижней части вы увидите длинную строку с шестнадцатеричным значением, подобную показанной ниже. Разверните ее, после чего разверните область «no domain», и вы увидите свой скрипт:

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/script-in-sources.png', 303, 277, layout='intrinsic', alt='amp-script JavaScript in DevTools Sources panel', align='center' ) }}

# Добавление нашего JavaScript-кода

Теперь, когда мы знаем, что наш `<amp-script>` работает, давайте добавим JavaScript-код!

Первое, что нужно сделать, — это найти элементы DOM, с которыми мы будем работать, и сохранить их в глобальных переменных. Наш код будет использовать поле ввода пароля, кнопку «Отправить» и область, где показываются правила ввода пароля. Добавьте эти объявления в файл `validate.js`:

```js
const passwordBox = document.getElementById("passwordBox");
const submitButton = document.getElementById("submitButton");
const rulesArea = document.getElementById("rules");
```

Обратите внимание, что нам доступны стандартные методы DOM API, такие как `getElementById()`. Несмотря на то, что наш код работает в воркере, а у воркеров отсутствует прямой доступ к DOM, `<amp-script>` предоставляет виртуальную копию DOM и эмулирует ряд распространенных API, перечисленных [здесь](https://github.com/ampproject/worker-dom/blob/main/web_compat_table.md). Такие API предоставляют нам достаточно инструментов для охвата большинства сценариев. Однако важно помнить, что поддержка функциональности DOM API является неполной. В противном случае поставляемый с `<amp-script>` JavaScript-код был бы огромен, тем самым сводя на нет преимущества AMP в плане производительности.

Нам нужно добавить использованные выше идентификаторы к двум элементам. Откройте файл `index.html`, найдите соответствующий полю пароля элемент `<input>` и соответствующий кнопке «Отправить» элемент `<button>`, после чего добавьте в них атрибуты «id». Кроме того, добавьте в элемент `<button>` атрибут `disabled`, чтобы не дать пользователю нажимать на кнопку, пока это не будет нам нужно.

```html
<input type=password
       id="passwordBox"

...

<button type="submit" id="submitButton" tabindex="3" disabled>Submit</button>
```

Перезагрузите страницу. Вы можете удостовериться, что глобальные переменные установлены корректно, просмотрев консоль (так же, как при работе с обычным JavaScript):

{{ image('/static/img/docs/tutorials/custom-javascript-tutorial/global-set.png', 563, 38, layout='intrinsic', alt='Console message showing submitButton is set', align='center' ) }}

Мы также добавим атрибуты id к каждому элементу `<li>` в `<div id="rules">`. Каждый из этих элементов содержит индивидуальное правило, цветом которого мы хотим управлять. Кроме того, мы удалим все экземпляры `class="invalid"`. Наш новый JavaScript-код добавит их, когда возникнет необходимость.

```html
<ul>
  <li id="lower">Lowercase letter</li>
  <li id="upper">Capital letter</li>
  <li id="digit">Digit</li>
  <li id="special">Special character (@$!%*?&)</li>
  <li id="eight">At least 8 characters long</li>
</ul>
```

## Реализация алгоритмов проверки пароля в нашем JavaScript

Далее мы распакуем регулярные выражения из атрибута `pattern`. Как вы помните, каждое регулярное выражение соответствует одному из правил. Давайте добавим в конец `validate.js` объект, ассоциирующий правила с проверяемыми ими критериями.

```js
const checkRegexes = {
  lower: /[a-z]/,
  upper: /[A-Z]/,
  digit: /\d/,
  special: /[^a-zA-Z\d]/i,
  eight: /.{8}/
};
```

Установив глобальные переменные, мы готовы писать логику, которая проверяет пароль и вносит необходимые изменения в UI. Мы поместим нашу логику в функцию `initCheckPassword`, которая принимает один аргумент — DOM-элемент, соответствующий элементу `<input>` поля пароля. Данный способ позволяет удобно сохранить DOM-элемент в замыкании.

```js
function initCheckPassword(element) {

}
```

Далее давайте добавим в `initCheckPassword` нужные нам функции и выполним назначение слушателей событий. Прежде всего добавьте простую функцию, которая делает индивидуальное правило `<li>` зеленым, если правило соблюдено, а также еще одну функцию, которая делает правило красным, если оно нарушено.

```js
function initCheckPassword(el) {
  const checkPass = (el) =&gt; {
    el.classList.remove("invalid");
    el.classList.add("valid");
  };

  const checkFail = (el) =&gt; {
    el.classList.remove("valid");
    el.classList.add("invalid");
  };
};
```

Теперь давайте сделаем так, чтобы классы `valid` и `invalid` действительно делали текст зеленым или красным. Вернитесь в `index.html` и добавьте следующие правила в тег `<style amp-custom>`:

```css
li.valid {
  color: #2d7b1f;
}

li.invalid {
  color:#c11136;
}
```

Мы готовы добавить логику, которая проверяет содержимое элемента `<input>` на основании наших правил. Добавьте в `initCheckPassword()` новую функцию `checkPassword()` прямо перед закрывающей скобкой:

```js
const checkPassword = () =&gt; {
  const password = element.value;
  let failed = false;

  for (const check in checkRegexes) {
    let li = document.getElementById(check);

    if (password.match(checkRegexes[check])) {
      checkPass(li);
    } else {
      checkFail(li);
      failed = true;
    }
  }

  if (!failed) {
    submitButton.removeAttribute("disabled");
  }
};
```

Эта функция делает следующее:

1. Извлекает содержимое поля `<input>`.
2. Создает флаг `failed`, инициализируя его в значении `false`.
3. Перебирает все регулярные выражения, сравнивая каждое из них с паролем:
    - Если пароль не проходит тест, вызывает `checkFail()`, чтобы сделать соответствующее правило красным и установить флаг `failed` в значение `true`.
    - Если пароль проходит тест, вызывает `checkPass()`, чтобы сделать соответствующее правило зеленым.
4. И наконец, если нарушенных правил нет, это означает, что пароль корректен, и мы делаем кнопку «Отправить» активной.

Все, что нам теперь нужно, — это пара слушателей событий. Помните, как мы не могли использовать событие `focus` в AMP? В `<amp-script>` мы это можем. Каждый раз, когда соответствующий полю пароля элемент `<input>` получает событие `focus`, мы будем отображать правила. А всякий раз, когда пользователь нажимает кнопку в этом поле, мы будем вызывать `checkPassword()`.

Добавьте эти слушатели в конец `initCheckPassword()`, прямо перед закрывающей скобкой:

```js
element.addEventListener("focus", () =&gt; rulesArea.removeAttribute("hidden"));
element.addEventListener("keyup", checkPassword);
```

И наконец, в самом конце файла `validate.js` добавьте строку, которая инициализирует `initCheckPassword`, используя DOM-элемент, соответствующий элементу `<input>` для ввода пароля:

```js
initCheckPassword(passwordBox);
```

Мы завершили создание нашей логики! При соответствии вводимого пароля всем нашим критериям все правила будут зелеными, а кнопка «Отправить» — активна. Теперь вы можете взаимодействовать с формой следующим образом:


<figure class="alignment-wrapper margin-"> {amp-video1} <source src="/static/img/docs/tutorials/custom-javascript-tutorial/finished-project.mp4" type="video/mp4"> <source src="/static/img/docs/tutorials/custom-javascript-tutorial/finished-project.webm" type="video/webm"> {/amp-video1} </source></source></figure> Если в процессе написания кода у вас возникли затруднения, вы всегда можете свериться с рабочей версией кода в директории `finished_code`.

# Поздравляем!

Вы научились пользоваться компонентом `<amp-script>`, чтобы писать собственный код JavaScript в AMP. Вы смогли оптимизировать компонент `<amp-form>`, добавив в него собственную логику и функции UI. Если хотите, вы можете продолжить расширять функциональность вашей страницы. Чтобы получить дополнительную информацию о компоненте `<amp-script>`, ознакомьтесь со [справочной документацией](../../../documentation/components/reference/amp-script.md).
